<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cây Gia phả - Hệ thống Gia phả</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: white !important;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tree-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 600px;
            overflow: auto;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .person-node {
            cursor: pointer;
        }
        
        /* Loại bỏ transform scale để tránh nhảy layout */
        
        .person-node rect {
            fill: #667eea;
            stroke: #764ba2;
            stroke-width: 3px;
            rx: 8;
            transition: stroke-width 0.2s, filter 0.2s;
            pointer-events: all;
        }
        
        .person-node.female rect {
            fill: #f093fb;
            stroke: #e91e63;
        }
        
        .person-node.male rect {
            fill: #4facfe;
            stroke: #2196f3;
        }
        
        .person-node .avatar-circle {
            fill: rgba(255, 255, 255, 0.3);
            stroke: white;
            stroke-width: 2px;
            transition: stroke-width 0.2s;
            pointer-events: none;
        }
        
        .person-node .avatar-icon {
            font-size: 28px;
            pointer-events: none;
        }
        
        .person-node .person-name {
            fill: white;
            font-size: 10px;
            font-weight: 700;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        .person-node .person-name-long {
            fill: white;
            font-size: 9px;
            font-weight: 700;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        .person-node .person-year {
            fill: rgba(255, 255, 255, 0.9);
            font-size: 10px;
            text-anchor: middle;
            font-weight: 500;
            pointer-events: none;
            user-select: none;
        }
        
        .person-node circle {
            pointer-events: none;
        }
        
        /* Hover trên toàn node nhưng không scale - chỉ thay đổi màu sắc */
        .person-node:hover rect {
            stroke-width: 4px;
            filter: brightness(1.15);
        }
        
        .person-node:hover .avatar-circle {
            stroke-width: 3px;
        }
        
        /* Đảm bảo text không trigger hover state */
        .person-node text {
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2px;
            stroke-opacity: 0.6;
            marker-end: url(#arrowhead);
        }
        
        .spouse-link {
            stroke: #ff6b6b;
            stroke-width: 3px;
            stroke-dasharray: 5,5;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 0;
            height: 100%;
        }
        
        .stats-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .person-detail-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .person-detail-label {
            font-weight: 600;
            color: #667eea;
            min-width: 120px;
            display: inline-block;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 10px;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
        }
        
        .tree-container {
            position: relative;
        }
        
        /* Tree Search */
        .tree-search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 250px;
        }
        
        .tree-search-container input {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 35px 8px 10px;
            width: 100%;
        }
        
        .tree-search-container .search-icon {
            position: absolute;
            right: 20px;
            top: 18px;
            color: #667eea;
        }
        
        .person-node.highlighted rect {
            stroke: #ff6b6b !important;
            stroke-width: 5px !important;
            filter: brightness(1.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                stroke-width: 5px;
            }
            50% {
                stroke-width: 6px;
            }
        }
        
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-loading i {
            animation: spin 1s linear infinite;
        }
        
        /* Person Search Dropdown */
        #personDropdown {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            margin-top: 2px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }
        
        #personDropdown .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        #personDropdown .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        #personDropdown .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .position-relative {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/home">
                <i class="fas fa-home"></i> Hệ thống Gia phả
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/members">
                            <i class="fas fa-users"></i> Thành viên
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/families">
                            <i class="fas fa-home"></i> Gia đình
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/family-tree">
                            <i class="fas fa-sitemap"></i> Cây Gia phả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/events">
                            <i class="fas fa-calendar"></i> Sự kiện
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/finance">
                            <i class="fas fa-dollar-sign"></i> Tài chính
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span th:text="${user.name}">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/logout">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="fas fa-sitemap text-primary"></i> Cây Gia phả
                    </h1>
                    <p class="text-muted mb-0">Trực quan hóa mối quan hệ huyết thống</p>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Chọn người để bắt đầu cây gia phả (chỉ con trai):</label>
                        <div class="position-relative">
                            <input type="text" 
                                   class="form-control" 
                                   id="personSearchInput" 
                                   placeholder="Tìm kiếm theo tên..."
                                   autocomplete="off"
                                   th:data-selected-id="${selectedRootId}">
                            <div class="dropdown-menu w-100" id="personDropdown" style="max-height: 300px; overflow-y: auto; display: none;">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                            <input type="hidden" id="rootSelect" value="">
                            <script th:inline="javascript">
                                /*<![CDATA[*/
                                window.allPersonsData = /*[[${allPersonsJson}]]*/ [];
                                window.selectedRootId = /*[[${selectedRootId}]]*/ null;
                                /*]]>*/
                            </script>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Chế độ hiển thị:</label>
                        <select class="form-select" id="viewMode">
                            <option value="full">Đầy đủ</option>
                            <option value="descendant">Chỉ con cháu</option>
                            <option value="ancestor">Chỉ tổ tiên</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="loadTree()">
                            <i class="fas fa-sync"></i> Tải Cây
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4 g-3" id="statsPanel" style="display: none;">
                <div class="col-6">
                    <div class="stats-card">
                        <h3 id="totalPeople">0</h3>
                        <p><i class="fas fa-users"></i> Tổng số người trong cây</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stats-card">
                        <h3 id="maxGeneration">0</h3>
                        <p><i class="fas fa-layer-group"></i> Số thế hệ</p>
                    </div>
                </div>
            </div>

            <!-- Tree Container -->
            <div class="tree-container" id="treeContainer">
                <!-- Tree Search Box -->
                <div class="tree-search-container" id="treeSearchContainer" style="display: none;">
                    <div class="position-relative">
                        <input type="text" 
                               class="form-control" 
                               id="treeSearchInput" 
                               placeholder="Tìm kiếm trong cây..."
                               autocomplete="off">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div id="searchResults" class="mt-2" style="display: none;">
                        <small class="text-muted" id="searchResultsText"></small>
                    </div>
                </div>
                
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div class="loading-text">Đang tải cây gia phả...</div>
                    </div>
                </div>
                
                <div class="text-center text-muted py-5" id="emptyState">
                    <i class="fas fa-sitemap fa-3x mb-3"></i>
                    <p>Chọn người để bắt đầu hiển thị cây gia phả</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Person Detail Modal -->
    <div class="modal fade" id="personDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin thành viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="personDetailContent">
                    <!-- Content will be filled by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let treeData = null;
        let svg, width, height;
        let tree = d3.tree();
        let root = null;
        let currentZoom = null;
        let d3Root = null;
        let g = null;
        
        // Lưu danh sách tất cả nam giới
        let allMales = [];
        
        // Khởi tạo danh sách nam giới từ server
        function initializeMales() {
            // Lấy dữ liệu từ window (đã được set từ Thymeleaf)
            const allPersons = window.allPersonsData || [];
            
            // Filter chỉ lấy nam giới (MALE hoặc "Nam")
            allMales = allPersons.filter(p => {
                const gender = (p.gender || "").toLowerCase();
                const genderDisplay = (p.genderDisplay || "").toLowerCase();
                return gender === "male" || gender === "nam" || gender === "m" ||
                       genderDisplay === "nam" || genderDisplay === "male";
            });
            
            // Nếu có selectedRootId, set giá trị mặc định
            const selectedId = window.selectedRootId;
            if (selectedId) {
                const selectedPerson = allMales.find(p => p.id == selectedId);
                if (selectedPerson) {
                    const searchInput = document.getElementById("personSearchInput");
                    const hiddenInput = document.getElementById("rootSelect");
                    if (searchInput) searchInput.value = selectedPerson.name || "";
                    if (hiddenInput) hiddenInput.value = selectedPerson.id || "";
                }
            }
        }
        
        // Xử lý tìm kiếm
        function setupPersonSearch() {
            const searchInput = document.getElementById("personSearchInput");
            const dropdown = document.getElementById("personDropdown");
            const hiddenInput = document.getElementById("rootSelect");
            
            searchInput.addEventListener("input", function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    dropdown.style.display = "none";
                    hiddenInput.value = "";
                    return;
                }
                
                // Lọc danh sách theo tên
                const filtered = allMales.filter(person => 
                    person.name.toLowerCase().includes(query)
                );
                
                // Hiển thị kết quả
                if (filtered.length > 0) {
                    dropdown.innerHTML = filtered.map(person => `
                        <div class="dropdown-item" data-id="${person.id}" data-name="${person.name}">
                            ${person.name}
                        </div>
                    `).join("");
                    dropdown.style.display = "block";
                    
                    // Thêm event listeners cho các items
                    dropdown.querySelectorAll(".dropdown-item").forEach(item => {
                        item.addEventListener("click", function() {
                            const personId = this.getAttribute("data-id");
                            const personName = this.getAttribute("data-name");
                            searchInput.value = personName;
                            hiddenInput.value = personId;
                            dropdown.style.display = "none";
                            // Tự động load tree nếu đã chọn
                            if (personId) {
                                loadTree();
                            }
                        });
                    });
                } else {
                    dropdown.innerHTML = '<div class="dropdown-item text-muted">Không tìm thấy</div>';
                    dropdown.style.display = "block";
                    hiddenInput.value = "";
                }
            });
            
            // Đóng dropdown khi click bên ngoài
            document.addEventListener("click", function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = "none";
                }
            });
            
            // Mở dropdown khi focus vào input
            searchInput.addEventListener("focus", function() {
                if (this.value.length > 0) {
                    this.dispatchEvent(new Event("input"));
                } else {
                    // Hiển thị tất cả nam giới nếu chưa nhập gì
                    dropdown.innerHTML = allMales.map(person => `
                        <div class="dropdown-item" data-id="${person.id}" data-name="${person.name}">
                            ${person.name}
                        </div>
                    `).join("");
                    
                    dropdown.querySelectorAll(".dropdown-item").forEach(item => {
                        item.addEventListener("click", function() {
                            const personId = this.getAttribute("data-id");
                            const personName = this.getAttribute("data-name");
                            searchInput.value = personName;
                            hiddenInput.value = personId;
                            dropdown.style.display = "none";
                            if (personId) {
                                loadTree();
                            }
                        });
                    });
                    
                    dropdown.style.display = "block";
                }
            });
        }

        // Initialize SVG
        function initSVG() {
            d3.select("#treeContainer").select("svg").remove();
            
            const emptyState = document.getElementById("emptyState");
            if (emptyState) {
                emptyState.style.display = "none";
            }
            
            width = document.getElementById("treeContainer").offsetWidth;
            height = Math.max(600, width * 0.6);
            
            svg = d3.select("#treeContainer")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
                
            // Add arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 15)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5");
        }

        // Show loading
        function showLoading() {
            const loadingOverlay = document.getElementById("loadingOverlay");
            const emptyState = document.getElementById("emptyState");
            const loadButton = document.querySelector("button[onclick='loadTree()']");
            
            if (loadingOverlay) {
                loadingOverlay.classList.add("show");
            }
            if (emptyState) {
                emptyState.style.display = "none";
            }
            if (loadButton) {
                loadButton.classList.add("btn-loading");
                loadButton.disabled = true;
            }
        }
        
        // Hide loading
        function hideLoading() {
            const loadingOverlay = document.getElementById("loadingOverlay");
            const loadButton = document.querySelector("button[onclick='loadTree()']");
            
            if (loadingOverlay) {
                loadingOverlay.classList.remove("show");
            }
            if (loadButton) {
                loadButton.classList.remove("btn-loading");
                loadButton.disabled = false;
            }
        }

        // Load tree data
        async function loadTree() {
            const rootSelect = document.getElementById("rootSelect");
            const selectedRootId = rootSelect ? rootSelect.value : null;
            
            if (!selectedRootId) {
                alert("Vui lòng chọn người để bắt đầu!");
                return;
            }
            
            // Hiển thị loading
            showLoading();
            
            const viewMode = document.getElementById("viewMode").value;
            const mode = viewMode === "full" ? "" : viewMode;
            
            try {
                const response = await fetch(`/family-tree/api/data/${selectedRootId}?mode=${mode}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data) {
                    treeData = data;
                    // Thêm delay nhỏ để hiển thị loading ít nhất 500ms
                    await new Promise(resolve => setTimeout(resolve, 500));
                    drawTree();
                    updateStats();
                } else {
                    alert("Không tìm thấy dữ liệu!");
                }
            } catch (error) {
                console.error("Error loading tree:", error);
                alert("Có lỗi xảy ra khi tải cây gia phả!");
            } finally {
                // Ẩn loading
                hideLoading();
            }
        }

        // Convert tree data to D3 format
        function convertToD3Format(node, parent = null) {
            const d3Node = {
                id: node.id,
                name: node.name,
                gender: node.gender,
                dob: node.dob,
                dod: node.dod,
                isAlive: node.isAlive,
                address: node.address,
                phone: node.phone,
                spouse: node.spouse,
                children: []
            };
            
            if (parent) {
                d3Node.parent = parent;
            }
            
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    d3Node.children.push(convertToD3Format(child, d3Node));
                });
            }
            
            return d3Node;
        }

        // Draw tree
        function drawTree() {
            if (!treeData) return;
            
            initSVG();
            
            d3Root = d3.hierarchy(treeData);
            
            // Node size - vuông, tăng kích thước để hiển thị đầy đủ tên
            const nodeSize = 140;
            tree.nodeSize([nodeSize + 30, nodeSize + 100]);
            tree(d3Root);
            
            g = svg.append("g")
                .attr("transform", `translate(${width/2}, 50)`);
            
            // Khai báo transform cho zoom
            let currentTransform = d3.zoomIdentity;
            
            // Draw links - đường vuông góc (orthogonal)
            g.selectAll(".link")
                .data(d3Root.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d => {
                    const sourceY = d.source.y + nodeSize/2;
                    const targetY = d.target.y - nodeSize/2;
                    const midY = (d.source.y + d.target.y) / 2;
                    
                    // Đường vuông góc: đi xuống từ source, sang ngang, rồi đi lên đến target
                    return `
                        M${d.source.x},${sourceY}
                        L${d.source.x},${midY}
                        L${d.target.x},${midY}
                        L${d.target.x},${targetY}
                    `;
                });
            
            // Helper function to determine gender
            function getGenderClass(gender) {
                if (!gender) return "male";
                const g = gender.toLowerCase();
                if (g === "nữ" || g === "female") return "female";
                return "male";
            }
            
            function isFemale(gender) {
                if (!gender) return false;
                const g = gender.toLowerCase();
                return g === "nữ" || g === "female";
            }
            
            // Draw nodes
            const node = g.selectAll(".person-node")
                .data(d3Root.descendants())
                .enter()
                .append("g")
                .attr("class", d => {
                    return `person-node ${getGenderClass(d.data.gender)}`;
                })
                .attr("transform", d => `translate(${d.x},${d.y})`);
            
            // Add square rectangles for nodes (vuông) - đây là phần chính để click
            node.append("rect")
                .attr("x", -nodeSize/2)
                .attr("y", -nodeSize/2)
                .attr("width", nodeSize)
                .attr("height", nodeSize)
                .attr("rx", 8)
                .style("cursor", "pointer")
                .on("click", function(event, d) {
                    event.preventDefault();
                    event.stopPropagation();
                    // Đảm bảo modal được mở đúng cách
                    setTimeout(() => {
                        showPersonDetail(d.data);
                    }, 10);
                })
                .on("mousedown", function(event) {
                    // Ngăn zoom khi bắt đầu click vào rect
                    if (event.target.tagName === 'rect') {
                        event.stopPropagation();
                    }
                });
            
            // Add avatar circle
            node.append("circle")
                .attr("class", "avatar-circle")
                .attr("cx", 0)
                .attr("cy", -nodeSize/2 + 35)
                .attr("r", 25);
            
            // Add avatar icon - sử dụng emoji
            node.append("text")
                .attr("class", "avatar-icon")
                .attr("text-anchor", "middle")
                .attr("dy", -nodeSize/2 + 48)
                .attr("font-size", "28px")
                .style("pointer-events", "none")
                .text(d => {
                    return isFemale(d.data.gender) ? "👩" : "👨";
                });
            
            // Add name text - hiển thị đầy đủ, có thể xuống dòng
            node.each(function(d) {
                const name = d.data.name || "N/A";
                const nodeGroup = d3.select(this);
                const maxWidth = nodeSize - 10; // Chiều rộng tối đa cho text
                const fontSize = 10;
                const words = name.split(' ');
                
                // Tính toán để hiển thị đầy đủ tên
                let line = '';
                let yOffset = 18;
                const lineHeight = fontSize + 2;
                
                words.forEach((word, i) => {
                    const testLine = line + (line ? ' ' : '') + word;
                    // Ước tính chiều rộng text (xấp xỉ)
                    const textWidth = testLine.length * (fontSize * 0.6);
                    
                    if (textWidth > maxWidth && line) {
                        // Thêm dòng hiện tại và bắt đầu dòng mới
                        nodeGroup.append("text")
                            .attr("class", "person-name")
                            .attr("text-anchor", "middle")
                            .attr("dy", yOffset)
                            .text(line);
                        line = word;
                        yOffset += lineHeight;
                    } else {
                        line = testLine;
                    }
                });
                
                // Thêm dòng cuối cùng
                nodeGroup.append("text")
                    .attr("class", yOffset > 18 ? "person-name-long" : "person-name")
                    .attr("text-anchor", "middle")
                    .attr("dy", yOffset)
                    .text(line);
            });
            
            // Add year of birth and death - điều chỉnh vị trí dựa trên số dòng tên
            node.each(function(d) {
                const nodeGroup = d3.select(this);
                const name = d.data.name || "N/A";
                const words = name.split(' ');
                const maxWidth = nodeSize - 10;
                const fontSize = 10;
                let line = '';
                let lineCount = 1;
                
                words.forEach((word, i) => {
                    const testLine = line + (line ? ' ' : '') + word;
                    const textWidth = testLine.length * (fontSize * 0.6);
                    
                    if (textWidth > maxWidth && line) {
                        lineCount++;
                        line = word;
                    } else {
                        line = testLine;
                    }
                });
                
                // Vị trí năm dựa trên số dòng tên
                const yearY = 18 + (lineCount * 12) + 8;
                
                // Tính toán thông tin năm
                let yearInfo = "";
                if (d.data.dob) {
                    const birthYear = new Date(d.data.dob).getFullYear();
                    yearInfo = birthYear.toString();
                }
                if (d.data.dod) {
                    const deathYear = new Date(d.data.dod).getFullYear();
                    yearInfo += yearInfo ? ` - ${deathYear}` : deathYear;
                } else if (yearInfo) {
                    yearInfo += " - ...";
                }
                
                if (yearInfo) {
                    nodeGroup.append("text")
                        .attr("class", "person-year")
                        .attr("text-anchor", "middle")
                        .attr("dy", yearY)
                        .text(yearInfo);
                }
            });
            
            // Zoom support - chỉ zoom khi không click vào node
            currentZoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .filter(function(event) {
                    // Chỉ cho phép zoom với wheel (scroll) hoặc drag, không phải click đơn
                    if (event.type === 'mousedown' || event.type === 'mousemove') {
                        return true;
                    }
                    if (event.type === 'wheel') {
                        return true;
                    }
                    // Không cho zoom khi click đơn vào rect
                    if (event.type === 'click' && event.target && event.target.tagName === 'rect') {
                        return false;
                    }
                    return true;
                })
                .on("zoom", function(event) {
                    // Lưu transform hiện tại
                    currentTransform = event.transform;
                    g.attr("transform", event.transform);
                });
            
            svg.call(currentZoom);
            
            // Hiển thị search box khi cây được vẽ
            const searchContainer = document.getElementById("treeSearchContainer");
            if (searchContainer) {
                searchContainer.style.display = "block";
            }
        }
        
        // Tìm kiếm trong cây
        function searchInTree(query) {
            if (!d3Root || !query || query.trim().length === 0) {
                removeHighlight();
                return null;
            }
            
            const searchTerm = query.toLowerCase().trim();
            let foundNodes = [];
            
            // Tìm tất cả nodes có tên khớp
            d3Root.each(d => {
                const name = (d.data.name || "").toLowerCase();
                if (name.includes(searchTerm)) {
                    foundNodes.push(d);
                }
            });
            
            if (foundNodes.length === 0) {
                const resultsDiv = document.getElementById("searchResults");
                const resultsText = document.getElementById("searchResultsText");
                if (resultsDiv && resultsText) {
                    resultsDiv.style.display = "block";
                    resultsText.textContent = "Không tìm thấy";
                    resultsText.className = "text-danger";
                }
                removeHighlight();
                return null;
            }
            
            // Nếu có nhiều kết quả, lấy kết quả đầu tiên (hoặc có thể hiển thị danh sách)
            const targetNode = foundNodes[0];
            
            // Hiển thị kết quả
            const resultsDiv = document.getElementById("searchResults");
            const resultsText = document.getElementById("searchResultsText");
            if (resultsDiv && resultsText) {
                resultsDiv.style.display = "block";
                if (foundNodes.length > 1) {
                    resultsText.textContent = `Tìm thấy ${foundNodes.length} kết quả. Hiển thị kết quả đầu tiên.`;
                    resultsText.className = "text-info";
                } else {
                    resultsText.textContent = "Đã tìm thấy";
                    resultsText.className = "text-success";
                }
            }
            
            // Zoom và highlight node
            zoomToNode(targetNode);
            highlightNode(targetNode);
            
            return targetNode;
        }
        
        // Zoom đến node
        function zoomToNode(node) {
            if (!svg || !g || !node || !currentZoom) return;
            
            // Lấy transform hiện tại của g
            const currentTransform = d3.select(g.node()).attr("transform");
            
            // Vị trí node trong cây
            const nodeX = node.x;
            const nodeY = node.y;
            
            // Tính toán để đưa node vào giữa màn hình với scale = 2
            const scale = 2;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Transform để node xuất hiện ở giữa
            // Node ban đầu ở (nodeX, nodeY) với g transform là (width/2, 50)
            // Vị trí thực tế trên SVG: (width/2 + nodeX, 50 + nodeY)
            // Muốn node ở (centerX, centerY) sau khi scale
            // translate = center - node * scale
            const tx = centerX - nodeX * scale;
            const ty = centerY - nodeY * scale;
            
            // Tạo transform mới
            const transform = d3.zoomIdentity
                .translate(tx, ty)
                .scale(scale);
            
            // Animate zoom với smooth transition
            svg.transition()
                .duration(750)
                .ease(d3.easeCubicOut)
                .call(currentZoom.transform, transform);
        }
        
        // Highlight node
        function highlightNode(node) {
            if (!g || !node) return;
            
            // Bỏ highlight cũ
            removeHighlight();
            
            // Tìm node element và highlight
            const nodeElement = g.selectAll(".person-node")
                .filter(d => d.data.id === node.data.id);
            
            if (nodeElement.size() > 0) {
                nodeElement.node().classList.add("highlighted");
                
                // Tự động bỏ highlight sau 5 giây
                setTimeout(() => {
                    removeHighlight();
                }, 5000);
            }
        }
        
        // Bỏ highlight
        function removeHighlight() {
            if (!g) return;
            g.selectAll(".person-node").each(function() {
                this.classList.remove("highlighted");
            });
            
            const resultsDiv = document.getElementById("searchResults");
            if (resultsDiv) {
                resultsDiv.style.display = "none";
            }
        }

        // Show person detail
        function showPersonDetail(person) {
            const modal = new bootstrap.Modal(document.getElementById('personDetailModal'));
            const content = document.getElementById('personDetailContent');
            
            content.innerHTML = `
                <div class="person-detail-item">
                    <span class="person-detail-label">Tên:</span>
                    <span>${person.name || 'N/A'}</span>
                </div>
                <div class="person-detail-item">
                    <span class="person-detail-label">Giới tính:</span>
                    <span>${person.gender || 'N/A'}</span>
                </div>
                <div class="person-detail-item">
                    <span class="person-detail-label">Ngày sinh:</span>
                    <span>${person.dob || 'N/A'}</span>
                </div>
                <div class="person-detail-item">
                    <span class="person-detail-label">Ngày mất:</span>
                    <span>${person.dod || 'Còn sống'}</span>
                </div>
                <div class="person-detail-item">
                    <span class="person-detail-label">Địa chỉ:</span>
                    <span>${person.address || 'N/A'}</span>
                </div>
                <div class="person-detail-item">
                    <span class="person-detail-label">Số điện thoại:</span>
                    <span>${person.phone || 'N/A'}</span>
                </div>
                ${person.spouse ? `
                <div class="person-detail-item">
                    <span class="person-detail-label">Vợ/Chồng:</span>
                    <span>${person.spouse.name}</span>
                </div>
                ` : ''}
            `;
            
            modal.show();
        }

        // Update statistics
        async function updateStats() {
            const rootSelect = document.getElementById("rootSelect");
            const selectedRootId = rootSelect ? rootSelect.value : null;
            
            if (!selectedRootId) return;
            
            try {
                const response = await fetch(`/family-tree/api/stats/${selectedRootId}`);
                const stats = await response.json();
                
                if (stats) {
                    document.getElementById("totalPeople").textContent = stats.totalPeople;
                    document.getElementById("maxGeneration").textContent = stats.maxGeneration;
                    document.getElementById("statsPanel").style.display = "block";
                }
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        // Event listeners
        document.getElementById("viewMode").addEventListener("change", function() {
            const rootSelect = document.getElementById("rootSelect");
            if (rootSelect.value) {
                loadTree();
            }
        });
        
        // Setup tree search
        function setupTreeSearch() {
            const searchInput = document.getElementById("treeSearchInput");
            if (!searchInput) return;
            
            let searchTimeout = null;
            
            searchInput.addEventListener("input", function() {
                const query = this.value;
                
                // Clear timeout trước đó
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => {
                    searchInTree(query);
                }, 300);
            });
            
            // Clear search khi nhấn Escape
            searchInput.addEventListener("keydown", function(e) {
                if (e.key === "Escape") {
                    this.value = "";
                    removeHighlight();
                }
            });
        }
        
        // Khởi tạo search khi trang load
        document.addEventListener("DOMContentLoaded", function() {
            initializeMales();
            setupPersonSearch();
            setupTreeSearch();
        });
    </script>
</body>
</html>


